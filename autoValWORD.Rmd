---
output:
  html_document: default
  word_document: default
  pdf_document: default
  '': default
  allways_allow_html: true
---

---
output:
  html_document:
    css: "style.css"
    fig_width: 10
    fig_height: 10
    fig_caption: true
    df_print: paged
  pdf_document: default
  '': default
date: "`r format(Sys.time(), '%A %d. %B %Y')`"
---

```{r setup, include=FALSE}
library(knitr)
library(parallel)
library(robslopes)
library(readxl)
library(mcr)
opts_chunk$set(echo = TRUE)
```

<!-- Prepare libraries and import data from Excel -->

<!-- create vectors method.x and method.y, run Passing Bablok regression -->

<!-- change column names in PB.reg@mnames to prepare for dynamic title-, axis- & legend labels-->

```{r prepareData, echo=FALSE}

## Import Data from a xlsx file, create the vectors for reference x and test y
validation.data <- read_xlsx("C:/R_local/Validation_Data.xlsx")
method.x <- validation.data[[1]]
method.y <- validation.data[[2]]
## PaBa (formal class names: PB.reg) regression, rename column titles in PB.reg@mnames
PB.reg <- mcreg(method.x,method.y, method.reg = "PaBa")
PB.reg@mnames[1] <- colnames(validation.data)[1]
PB.reg@mnames[2] <- colnames(validation.data)[2]

```

---
title: "`r paste("Validation: ", colnames(validation.data)[2],"vs", colnames(validation.data)[1])`"
---

### Messdaten

```{r datatable, echo=FALSE}
kable(MCResult.getData(PB.reg), caption = paste(
  "S: sample Number;---x: ", colnames(validation.data)[1], ";---y: ", colnames(validation.data)[2]
    )
  )
```

### Korrelation

<!-- Pearsson correlation and plot, sample number n from PB.reg@data -->

```{r, echo=FALSE, out.height = "80%", out.width = "80%"}

## Correlation plot with Pearsson correlation
## Creating the plot
plot(method.x, method.y, pch = 19, col = "#68228B", 
     xlab=colnames(validation.data)[1], ylab=colnames(validation.data)[2])

## Regression line
abline(lm(method.y ~ method.x), col = "red", lwd = 3)

## Pearson correlation
text(paste("Pearson's r:", round(cor(method.x, method.y), 2)), x=max(method.x)*0.85, y=max(method.y)*0.1)
text(paste("n=", nrow(PB.reg@data)), x=40, y=5)

```

### Passing Bablok

<!-- Passing Bablok Plot mit Steigung, Achsenabschnitt, Spearman's correlation  -->

```{r PB, echo=FALSE, out.height = "80%", out.width = "80%"}

MCResult.plot(PB.reg, equal.axis = TRUE, x.lab = colnames(validation.data)[1], y.lab = colnames(validation.data)[2], points.col = "#68228B", points.pch = 19, ci.area = TRUE, ci.area.col = "#0000FF50", main = paste("Validation", colnames(validation.data)[2], "vs", colnames(validation.data)[1]), sub = "", add.cor = TRUE, cor.method = "spearman", add.grid = FALSE, points.cex = 1)
##Angabe Steigung und Achsenabschnitt und CI
intercept_est <- PB.reg@para[1]
intercept_lci <- PB.reg@para[5]
intercept_uci <- PB.reg@para[7]
gradient_est <- PB.reg@para[2]
gradient_lci <- PB.reg@para[6]
gradient_uci <- PB.reg@para[8]
alpha_ci <- PB.reg@alpha[1]
text(cex=.65,x=max(validation.data)*0.8,y=max(validation.data)*0.34,sprintf("Gradient : %4.2f (%4.2f - %4.2f)", gradient_est, gradient_lci, gradient_uci))
text(cex=.65,x=max(validation.data)*0.8,y=max(validation.data)*0.27,sprintf("Intercept : %4.2f (%4.2f - %4.2f)", intercept_est, intercept_lci, intercept_uci))
text(cex=.65,x=max(validation.data)*0.8,y=max(validation.data)*0.2, sprintf("alpha : %4.2f", alpha_ci))

```

### Bland-Altman

```{r BA, echo=FALSE, out.height = "80%", out.width = "80%"}
MCResult.plotDifference(PB.reg)
```

```{r BArel, echo=FALSE, out.height = "80%", out.width = "80%"}

MCResult.plotDifference(PB.reg, plot.type = 8, main = "rel Difference plot")
```

```{r Bias, echo=FALSE, out.height = "90%", out.width = "90%"}
## Calculation of models
m2 <- mcreg(method.x,method.y,method.reg="PaBa", method.ci="bootstrap",
            method.bootstrap.ci="BCa",mref.name=colnames(validation.data)[1],
            mtest.name=colnames(validation.data)[2], na.rm=TRUE)
## Drawing of proportional bias
plotBias(m2, ci.area=TRUE, ci.border=TRUE, cex.sub=0.2)

```

```{r Bias prop, echo=FALSE, out.height = "90%", out.width = "90%"}
plotBias(m2, ci.area=TRUE, ci.border=TRUE, prop=TRUE, cex.sub=0.2)
```



### Schlussfolgerung und Freigabe

<!-- User Input zur Beurteilung und Freigabe -->

Bitte gib hier Deine Beurteilung der vorliegenden Verifikation/Validation ein:  
|  
|  
|  
|  
|  
---

#### Data is processed using R language^1^ and mcr package^2^.  Rmarkdown^3^ is used for converting results into Word, PDF and HTML files. This project was inspired by Daniel Holmes (UBC, CA)^4^ and Burak Bahar (Washington, USA)^5^.

#### References and packages:

1. R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. Version: `r getRversion()` URL: https://www.R-project.org
2. mcr: Method Comparison Regression. Version: `r packageDescription("mcr")$Version` URL: http://CRAN.R-project.org/package=mcr
3. rmarkdown: Dynamic Documents for R. Version: `r packageDescription("rmarkdown")$Version` URL: http://rmarkdown.rstudio.com
4. The Lab-R-torian: URL: https://labrtorian.com/
5. An interactive website for analytical method comparison and bias estimation: URL: https://bahar.shinyapps.io/method_compare/


