---
output:
  word_document: default
  pdf_document: default
  html_document: default
  '': default
  allways_allow_html: true
---

```{r setup, echo=FALSE, message = FALSE}
library(knitr)
library(tidyverse)
library(parallel)
library(robslopes)
library(readxl)
library(mcr)
library(flextable)
opts_chunk$set(echo = TRUE)
```

<!-- Prepare libraries and import data from Excel -->

<!-- create vectors method.x and method.y, run Passing Bablok regression -->

<!-- change column names in PB.reg@mnames to prepare for dynamic title-, axis- & legend labels-->

```{r Datentabelle, echo=FALSE, message = FALSE}
library(readxl)
## Import Data from a xlsx file, create the vectors for reference x and test y
validation.data <- read_excel("C:/R_local/vdata.xlsx", sheet = "DATA")
val.crit <- read_excel("C:\\R_local\\vdata.xlsx", sheet = "CRIT")
val.info <- read_excel("C:\\R_local\\vdata.xlsx", sheet = "INFO")

val.prec <- read_excel(
    "C:/R_local/vdata.xlsx", sheet = "PREC"
)

method.x <- validation.data[[1]]
method.y <- validation.data[[2]]
## PaBa (formal class names: PB.reg) regression, rename column titles in PB.reg@mnames
PB.reg <- mcreg(method.x,method.y, method.reg = "PaBa")
PB.reg@mnames[1] <- colnames(validation.data)[1]
PB.reg@mnames[2] <- colnames(validation.data)[2]

```

---
title: "`r paste("Validierungsbericht", val.info$Messgröss[1])`"
---

| Abteilung         |                                                          |     |
|----------------------------------|-------------------|-------------------|
|                   | `r paste(val.info$Abteilung[1],val.info$Unternehmen[1])` |     |
| Durchführung      | `r paste("FV BMA Amanda Ferlez")`                        |     |
|                   | `r paste("L-BMA Anina Kühne")`                           |     |
| Fachliche Leitung | `r paste("Dr. Siegfried Stranders, FAMH")`               |     |

| Analytik   |                                        |            |
|------------|----------------------------------------|------------|
| Material   | `r paste(val.info$Material[1])`        | Alternativ |
| Messgrösse | `r paste(val.info$Messgröss[1])`       | Synonym    |
| Einheit    | `r paste("[",val.info$Einheit[1],"]")` |            |

| Bisher Methode x |                                                           |     |
|------------------|-------------------------------------|------------------|
| Labor            | `r paste(val.info$Unternehmen[2], val.info$Abteilung[2])` |     |
| Methode          | `r paste(val.info$Methode[2])`                            |     |
| Messinstrument   | `r paste(val.info$Messinstrument[2])`                     |     |
| Lieferant        | `r paste(val.info$Kit[2])`                                |     |

| Neue Methode y    |                                                                                           |     |
|------------------|-------------------------------------|------------------|
| Labor             | `r paste(val.info$Unternehmen[1], val.info$Abteilung[1])`                                 |     |
| Methode           | `r paste(val.info$Methode[1])`                                                            |     |
| Messinstrument    | `r paste(val.info$Messinstrument[1])`                                                     |     |
| Lieferant         | `r paste(val.info$Kit[1])`                                                                |     |
| Kit               | `r paste(val.info$Kit[1])`                                                                |     |
| Messbereich       | `r paste(val.info$Messbereich_L[1], "-", val.info$Messbereich_H[1], val.info$Einheit[1])` |     |
| Referenz Interval | `r paste(val.info$RefInterval_L[1], "-", val.info$RefInterval_H[1], val.info$Einheit[1])` |     |

| Akzeptanzkriterien     |                                                            |     |
|------------------|-------------------------------------|------------------|
| Anzahl Doppelmessungen | `r paste("≥", val.crit$n[1])`                              |     |
| VK intra-Assay         | `r paste("<", val.crit$intraVK[1], "%")`                   |     |
| VK inter-Assay         | `r paste("<", val.crit$interVK[1], "%")`                   |     |
| Korrelation r          | `r paste("≥", val.crit$Korr[1])`                           |     |
| PaBa Regression        | `r paste("Steigung m 1.0 ± ", val.crit$PaBa_slope_H[1]-1)` |     |

| QM-Dokumente |                                 |                                        |
|----------------------------------|-------------------|-------------------|
| Projekt      | `r paste(val.info$Projekt[1])`  | `r paste(val.info$Projekt_Titel[1])`   |
| Mutation     | `r paste(val.info$Mutation[1])` | `r paste(val.info$Mutations_Titel[1])` |

\newpage

### Messdaten  
  
```{r datatable, echo=FALSE}
table.one <- data.frame(seq.int(nrow(validation.data)),validation.data)
colnames(table.one)[1] = "# "

table.one$"delta.%" <- ((table.one[[3]]-table.one[[2]])
                        *100/mean(table.one[[2]]+table.one[[3]]))



kable(table.one, digits = 1, "simple")
```

### Präzision

```{r intra- and inter-assay coefficient of variability, echo = FALSE, message = FALSE}
library(tidyverse)
library(flextable)

cv <- function(x){sd(x)*100/mean(x)}

prec.data <- val.prec |> select(Messwert_intra1, Messwert_intra2, Messwert_inter1, Messwert_inter2)

prec.data.stat <-
  prec.data |> summarize(n = n(), across(
    Messwert_intra1:Messwert_inter2,
    list(
      Mittelwert = \(x) round(mean(x, na.rm = TRUE), digits = 2),
      StabW = \(x) round(sd(x, na.rm = TRUE), digits = 2),
      VK = \(x) round(cv(x), digits = 1)
    )
  ), )



intra.df <- data.frame(
  "Intra Assay" = c("n", "Zielwert", "Mittelwert", "SD", "VK (%)"),
  L = c(
    paste(prec.data.stat$n),
    paste(val.prec$Ziel_intra1[1]),
    paste(prec.data.stat$Messwert_intra1_Mittelwert),
    paste(prec.data.stat$Messwert_intra1_StabW),
    paste(prec.data.stat$Messwert_intra1_VK)
  ),
  H = c(
    paste(prec.data.stat$n),
    paste(val.prec$Ziel_intra2[1]),
    paste(prec.data.stat$Messwert_intra2_Mittelwert),
    paste(prec.data.stat$Messwert_intra2_StabW),
    paste(prec.data.stat$Messwert_intra2_VK)
  )
)

inter.df <- data.frame(
  "Inter Assay" = c("n", "Zielwert", "Mittelwert", "SD", "VK (%)"),
  L = c(
    paste(prec.data.stat$n),
    paste(val.prec$Ziel_inter1[1]),
    paste(prec.data.stat$Messwert_inter1_Mittelwert),
    paste(prec.data.stat$Messwert_inter1_StabW),
    paste(prec.data.stat$Messwert_inter1_VK)
  ),
  H = c(
    paste(prec.data.stat$n),
    paste(val.prec$Ziel_inter2[1]),
    paste(prec.data.stat$Messwert_inter2_Mittelwert),
    paste(prec.data.stat$Messwert_inter2_StabW),
    paste(prec.data.stat$Messwert_inter2_VK)
  )
)


intra.df.ft <- flextable(intra.df)
intra.df.ft <- align(intra.df.ft, align = "right", part = "all")
intra.df.ft <- autofit(intra.df.ft)
intra.df.ft |> bg(bg = "grey", part = "header")

inter.df.ft <- flextable(inter.df)
inter.df.ft <- align(inter.df.ft, align = "right", part = "all")
inter.df.ft <- autofit(inter.df.ft)
inter.df.ft |> bg(bg = "grey", part = "header")


```


### Korrelation

<!-- Pearsson correlation and plot, sample number n from PB.reg@data -->

```{r, echo=FALSE, out.height = "80%", out.width = "80%"}

## Correlation plot with Pearsson correlation
## Creating the plot
plot(method.x, method.y, pch = 19, col = "#68228B", 
     xlab=colnames(validation.data)[1], ylab=colnames(validation.data)[2])

## Regression line
abline(lm(method.y ~ method.x), col = "red", lwd = 3)

## Pearson correlation
text(paste("Pearson's r:", round(cor(method.x, method.y), 2)), x=max(method.x)*0.85, y=max(method.y)*0.1)
text(paste("n=", nrow(PB.reg@data)), x=40, y=5)

```

### Passing Bablok

<!-- Passing Bablok Plot mit Steigung, Achsenabschnitt, Spearman's correlation  -->

```{r PB, echo=FALSE, out.height = "80%", out.width = "80%"}

MCResult.plot(PB.reg, equal.axis = TRUE, x.lab = colnames(validation.data)[1], y.lab = colnames(validation.data)[2], points.col = "#68228B", points.pch = 19, ci.area = TRUE, ci.area.col = "#0000FF50", main = paste("Validation", colnames(validation.data)[2], "vs", colnames(validation.data)[1]), sub = "", add.cor = TRUE, cor.method = "spearman", add.grid = FALSE, points.cex = 1)
##Angabe Steigung und Achsenabschnitt und CI
intercept_est <- PB.reg@para[1]
intercept_lci <- PB.reg@para[5]
intercept_uci <- PB.reg@para[7]
gradient_est <- PB.reg@para[2]
gradient_lci <- PB.reg@para[6]
gradient_uci <- PB.reg@para[8]
alpha_ci <- PB.reg@alpha[1]
text(cex=.65,x=max(validation.data)*0.8,y=max(validation.data)*0.34,sprintf("Gradient : %4.2f (%4.2f - %4.2f)", gradient_est, gradient_lci, gradient_uci))
text(cex=.65,x=max(validation.data)*0.8,y=max(validation.data)*0.27,sprintf("Intercept : %4.2f (%4.2f - %4.2f)", intercept_est, intercept_lci, intercept_uci))
text(cex=.65,x=max(validation.data)*0.8,y=max(validation.data)*0.2, sprintf("alpha : %4.2f", alpha_ci))

```

```{r coef plot, echo = FALSE, comment = '', warning = FALSE, message = FALSE}
fit.PaBa <- mcreg(as.matrix(validation.data), method.reg="PaBa", na.rm=TRUE)
fit.lr <- mcreg(as.matrix(validation.data), method.reg="LinReg", na.rm=TRUE)
compareFit(fit.lr, fit.PaBa)
```

\newpage

### Bland-Altman

```{r BA, echo=FALSE, out.height = "80%", out.width = "80%"}
MCResult.plotDifference(PB.reg)
```

```{r BArel, echo=FALSE, out.height = "80%", out.width = "80%"}

MCResult.plotDifference(PB.reg, plot.type = 8, main = "rel Difference plot")
```

```{r Bias, echo=FALSE, out.height = "90%", out.width = "90%"}
## Calculation of models
m2 <- mcreg(method.x,method.y,method.reg="PaBa", method.ci="bootstrap",
            method.bootstrap.ci="BCa",mref.name=colnames(validation.data)[1],
            mtest.name=colnames(validation.data)[2], na.rm=TRUE)
## Drawing of proportional bias
plotBias(m2, ci.area=TRUE, ci.border=TRUE, cex.sub=0.2)

```

```{r Bias prop, echo=FALSE, out.height = "90%", out.width = "90%"}
plotBias(m2, ci.area=TRUE, ci.border=TRUE, prop=TRUE, cex.sub=0.2)
```

\newpage

### Schlussfolgerung und Freigabe

<!-- User Input zur Beurteilung und Freigabe -->

Bitte gib hier Deine Beurteilung der vorliegenden Verifikation/Validation ein:\
\|\
\|\
\|\
\|\
\|\
---

**Zentrum für Labormedizin St. Gallen, `r paste(format(Sys.time(), '%A %d. %B %Y'))`**

#### Data is processed using R language^1^ and mcr package^2^. Rmarkdown^3^ is used for converting results into Word, PDF and HTML files. This project was inspired by Daniel Holmes (UBC, CA)^4^ and Burak Bahar (Washington, USA)^5^.

#### References and packages:

1.  R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. Version: `r getRversion()` URL: <https://www.R-project.org>
2.  mcr: Method Comparison Regression. Version: `r packageDescription("mcr")$Version` URL: <http://CRAN.R-project.org/package=mcr>
3.  rmarkdown: Dynamic Documents for R. Version: `r packageDescription("rmarkdown")$Version` URL: <http://rmarkdown.rstudio.com>
4.  The Lab-R-torian: URL: <https://labrtorian.com/>
5.  An interactive website for analytical method comparison and bias estimation: URL: <https://bahar.shinyapps.io/method_compare/>
